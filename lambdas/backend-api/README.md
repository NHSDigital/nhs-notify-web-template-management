<!-- vale off -->
# Backend-api

Template UI backend APIs

## Template APIs

The openapi3 spec can found in the `terraform` module in [spec.tmpl.json](../../infrastructure/terraform/modules/backend-api/spec.tmpl.json).

If you have postman installed you can import the `spec` file and make request via postman.

## Get an Access token

Setup an authenticated AWS terminal and run

```bash
./scripts/sandbox_auth.sh <email> <password>
```

Grab the `AccessToken` and `api_base_url` from `sandbox_cognito_auth_token.json`

```bash
SANDBOX_TOKEN=$(jq -r .AccessToken sandbox_cognito_auth_token.json) && APIG_STAGE=$(jq -r .api_base_url.value ./sandbox_tf_outputs.json)
```

### GET - /v1/template/:templateId - Get a single template by id

Get a single template by id

```bash
curl --location "${APIG_STAGE}/v1/template/${TEMPLATE_ID}" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN"
```

### PUT - /v1/template/:templateId - Update a template

Will update template properties excluding templateStatus

```bash
curl -X POST --location "${APIG_STAGE}/v1/template/${TEMPLATE_ID}" \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER" \
--data '{
  "name": "<string>",
  "message": "<string>",
  "templateType": "SMS",
  "subject": "<string>"
}'
```

### PATCH - /v1/template/:templateId - Apply a partial update of a template

Only supports `name` attribute

```bash
curl -X PATCH --location "${APIG_STAGE}/v1/template/${TEMPLATE_ID}" \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER" \
--data '{
  "name": "<string>"
}'
```

### GET - /v1/templates - Get all templates

currently limited to 50 items

```bash
curl --location "${APIG_STAGE}/v1/templates" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN"
```

### POST - /v1/template - Create a template

Will create a single template.

```bash
curl -X POST --location "${APIG_STAGE}/v1/template" \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--data '{
  "templateType": "EMAIL",
  "name": "<string>",
  "message": "<string>",
  "subject": "<string>"
}'
```

### POST - /v1/letter-template - Create a letter template

Will create a single letter template. The CSV form part is optional. Do not set a content type header as this must be auto-generated by curl, so that it includes a form-data boundary.

```bash
PDF_PATH="./tests/test-team/fixtures/letters/with-personalisation/template.pdf"
CSV_PATH="./tests/test-team/fixtures/letters/with-personalisation/test-data.csv"
```

```bash
curl -X POST --location "${APIG_STAGE}/v1/letter-template" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--form "letterPdf=@${PDF_PATH};type=application/pdf;filename=template.pdf" \
--form "testCsv=@${CSV_PATH};type=text/csv;filename=test.csv" \
--form 'template={
  "templateType": "LETTER",
  "name": "example letter",
  "letterType": "x0",
  "language": "en",
  "letterVersion": "PDF"
}'
```

### DELETE - /v1/template/:templateId - Delete a template

Will delete a single template.

```bash
curl -X POST --location "${APIG_STAGE}/v1/template/${TEMPLATE_ID" \
--header "Authorization: $SANDBOX_TOKEN" \
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER"
```

### PATCH - /v1/template/:templateId/submit - Submit a template

Will submit a template.

```bash
curl -X PATCH --location "${APIG_STAGE}/v1/template/${TEMPLATE_ID}/submit" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER"
```

### POST - /v1/template/:templateId/proof - Request a proof of a template

Will trigger a proof request for the template.

```bash
curl -X POST --location "${APIG_STAGE}/v1/template/${TEMPLATE_ID}/proof" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER"
```

### GET - /v1/client-configuration - Get client configuration for the caller

```bash
curl --location "${APIG_STAGE}/v1/client-configuration" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN"
```

### GET - /v1/routing-configuration/:routingConfigId - Get a routing configuration by id

```bash
curl --location "${APIG_STAGE}/v1/routing-configuration/${ROUTING_CONFIG_ID}" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN"
```

### GET - /v1/routing-configurations - List routing configurations

```bash
curl --location "${APIG_STAGE}/v1/routing-configurations" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN"
```

### GET - /v1/routing-configurations/count - Count routing configurations

```bash
curl --location "${APIG_STAGE}/v1/routing-configurations/count" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN"
```

### POST - /v1/routing-configuration - Create a routing configuration

```bash
curl -X POST --location "${APIG_STAGE}/v1/routing-configuration" \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--data '{
  "campaignId": "campaign",
  "cascade": [{
      "cascadeGroups": ["standard"],
      "channel": "EMAIL",
      "channelType": "primary",
      "defaultTemplateId": "email_id"
   }],
  "cascadeGroupOverrides": [],
  "name": "RC name"
}'
```

### PATCH - /v1/routing-configuration/:routingConfigId - Update a routing configuration

```bash
curl -X PATCH --location "${APIG_STAGE}/v1/routing-configuration/${ROUTING_CONFIG_ID}" \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER" \
--data '{
  "campaignId": "campaign",
  "cascade": [{
      "cascadeGroups": ["standard"],
      "channel": "EMAIL",
      "channelType": "primary",
      "defaultTemplateId": "email_id"
   }],
  "cascadeGroupOverrides": [],
  "name": "New name"
}'
```

### PATCH - /v1/routing-configuration/:routingConfigId/submit - Submit a routing configuration

```bash
curl -X PATCH --location "${APIG_STAGE}/v1/routing-configuration/${ROUTING_CONFIG_ID}/submit" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN" \
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER"
```

### DELETE - /v1/routing-configuration/:routingConfigId - Delete a routing configuration

```bash
curl -X DELETE --location "${APIG_STAGE}/v1/routing-configuration/${ROUTING_CONFIG_ID}" \
--header 'Accept: application/json' \
--header "Authorization: $SANDBOX_TOKEN"
--header "X-Lock-Number: $CURRENT_LOCK_NUMBER"
```

<!-- vale on -->
